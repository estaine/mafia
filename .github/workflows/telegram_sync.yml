name: Telegram Bot Sync

on:
  repository_dispatch:
    types: [sync, overwrite]

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run sync
        id: sync
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SHEET_GID: ${{ secrets.SHEET_GID }}
        run: |
          # Import the sync engine and run it
          MODE="${{ github.event.client_payload.mode }}"
          
          python3 << EOF
          import json
          from sync_engine import sync_games
          
          mode = "$MODE"
          result = sync_games(mode=mode)
          
          # Write result to file for next step
          with open('sync_result.json', 'w') as f:
              json.dump(result, f)
          
          # Print result for logs
          print(json.dumps(result, indent=2))
          EOF
      
      - name: Send result to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ github.event.client_payload.chat_id }}
        run: |
          # Read the sync result
          RESULT=$(cat sync_result.json)
          
          python3 << 'EOF'
          import os
          import json
          import requests
          
          # Read result
          with open('sync_result.json', 'r') as f:
              result = json.load(f)
          
          bot_token = os.environ['TELEGRAM_BOT_TOKEN']
          chat_id = os.environ['CHAT_ID']
          
          # Format message based on mode and success
          if not result.get('success'):
              message = f"‚ùå <b>–ü–∞–º—ã–ª–∫–∞</b>\n\n{result.get('error', '–ù–µ–≤—è–¥–æ–º–∞—è –ø–∞–º—ã–ª–∫–∞')}"
          elif result['mode'] == 'sync':
              message = (
                  "‚úÖ <b>–°—ñ–Ω—Ö—Ä–∞–Ω—ñ–∑–∞—Ü—ã—è –∑–∞–≤–µ—Ä—à–∞–Ω–∞!</b>\n\n"
                  "üìä <b>–°—Ç–∞—Ç—ã—Å—Ç—ã–∫–∞:</b>\n"
                  f"‚Ä¢ –ì—É–ª—å–Ω—è—û —É –ë–î (–±—ã–ª–æ): {result['games_in_db_before']}\n"
                  f"‚Ä¢ –ì—É–ª—å–Ω—è—û —É —Ç–∞–±–ª—ñ—Ü—ã: {result['valid_games']}\n"
                  f"‚Ä¢ –£–∂–æ —Å—ñ–Ω—Ö—Ä–∞–Ω—ñ–∑–∞–≤–∞–Ω–∞: {result['games_skipped']}\n"
                  f"‚Ä¢ –ù—è–ø—Ä–∞–≤—ñ–ª—å–Ω—ã—Ö (–Ω–µ 10 –≥—É–ª—å—Ü–æ—û): {result['invalid_games']}\n"
                  f"‚Ä¢ –îa–¥–∞–¥–∑–µ–Ω–∞ –∑–∞—Ä–∞–∑: {result['games_synced']}\n"
                  f"‚Ä¢ –ù–æ–≤—ã—Ö –≥—É–ª—å—Ü–æ—û: {result['players_created']}\n"
                  f"‚Ä¢ –ì—É–ª—å–Ω—è—û —É –ë–î (–∑–∞—Ä–∞–∑): {result['games_in_db_after']}"
              )
          else:  # overwrite
              message = (
                  "‚ö†Ô∏è <b>–ü–µ—Ä–∞–∑–∞–ø—ñ—Å –∑–∞–≤–µ—Ä—à–∞–Ω—ã!</b>\n\n"
                  "üìä <b>–°—Ç–∞—Ç—ã—Å—Ç—ã–∫–∞:</b>\n"
                  f"‚Ä¢ –ì—É–ª—å–Ω—è—û —É —Ç–∞–±–ª—ñ—Ü—ã: {result['valid_games']}\n"
                  f"‚Ä¢ –Ü–º–ø–∞—Ä—Ç–∞–≤–∞–Ω–∞: {result['games_synced']}\n"
                  f"‚Ä¢ –ê–¥—Ö—ñ–ª–µ–Ω–∞: {result['invalid_games']}\n"
                  f"  - –ù–µ 10 –≥—É–ª—å—Ü–æ—û: {result['invalid_games']}\n"
                  f"‚Ä¢ –ì—É–ª—å—Ü–æ—û —Å—Ç–≤–æ—Ä–∞–Ω–∞: {result['players_created']}\n"
                  f"‚Ä¢ –£—Å—è–≥–æ –≥—É–ª—å–Ω—è—û —É –ë–î: {result['games_in_db_after']}"
              )
          
          # Send message
          url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
          payload = {
              "chat_id": chat_id,
              "text": message,
              "parse_mode": "HTML"
          }
          
          response = requests.post(url, json=payload)
          if response.ok:
              print("‚úì Message sent to Telegram")
          else:
              print(f"‚úó Failed to send message: {response.status_code}")
              print(response.text)
          EOF
      
      - name: Cleanup
        if: always()
        run: rm -f sync_result.json

